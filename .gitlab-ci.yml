# =============================================================================
# GitLab CI/CD — Merge Request Verification Pipelines
# =============================================================================
# Runs lint, test, and build checks for both backend (Go) and frontend (React)
# on every merge request and on pushes to the default branch.
# =============================================================================

stages:
  - generate
  - verify

# ---------------------------------------------------------------------------
# Global defaults
# ---------------------------------------------------------------------------
default:
  interruptible: true

variables:
  GOPATH: "$CI_PROJECT_DIR/.go"
  GOMODCACHE: "$CI_PROJECT_DIR/.go/pkg/mod"

# ---------------------------------------------------------------------------
# Workflow — only run on MRs and the default branch
# ---------------------------------------------------------------------------
workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# Stage: generate
# =============================================================================

generate:backend:
  stage: generate
  image: golang:1.26.0-alpine
  before_script:
    - apk add --no-cache git
    - go install github.com/swaggo/swag/cmd/swag@latest
  script:
    - cd apps/backend
    # 1. Generate Swagger docs (ent depends on this)
    - swag init -g cmd/dev/main.go --output api/swag-docs --parseDependency --parseInternal
    # 2. Generate Ent ORM code
    - go generate ./ent/...
    # 3. Generate event types
    - go generate ./internal/domain/project/events/...
  cache:
    - key:
        files:
          - apps/backend/go.sum
      paths:
        - .go/pkg/mod/
      policy: pull-push
  artifacts:
    paths:
      - apps/backend/api/swag-docs/
      - apps/backend/ent/
      - apps/backend/internal/domain/project/events/
    expire_in: 1 hour

# =============================================================================
# Stage: verify — Backend
# =============================================================================

lint:backend:
  stage: verify
  image: golangci/golangci-lint:v2.9.0-alpine
  needs:
    - job: generate:backend
      artifacts: true
  script:
    - cd apps/backend
    - golangci-lint run ./...
  cache:
    - key:
        files:
          - apps/backend/go.sum
      paths:
        - .go/pkg/mod/
      policy: pull
  rules:
    - if: $CI_MERGE_REQUEST_IID
      changes:
        - apps/backend/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps/backend/**/*

test:backend:
  stage: verify
  image: golang:1.26.0-alpine
  needs:
    - job: generate:backend
      artifacts: true
  before_script:
    - apk add --no-cache gcc musl-dev  # needed for CGO (sqlite3 in tests)
  script:
    - cd apps/backend
    - go test ./...
  cache:
    - key:
        files:
          - apps/backend/go.sum
      paths:
        - .go/pkg/mod/
      policy: pull
  rules:
    - if: $CI_MERGE_REQUEST_IID
      changes:
        - apps/backend/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps/backend/**/*

build:backend:
  stage: verify
  image: golang:1.26.0-alpine
  needs:
    - job: generate:backend
      artifacts: true
  script:
    - cd apps/backend
    - go build -o bin/server ./cmd/dev/main.go
  cache:
    - key:
        files:
          - apps/backend/go.sum
      paths:
        - .go/pkg/mod/
      policy: pull
  rules:
    - if: $CI_MERGE_REQUEST_IID
      changes:
        - apps/backend/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps/backend/**/*

# =============================================================================
# Stage: verify — Frontend
# =============================================================================

.frontend_base:
  image: node:24-alpine
  needs:
    - job: generate:backend
      artifacts: true
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.28.2 --activate
    - pnpm install --frozen-lockfile
    # Generate API client from backend swagger artifacts
    - cd apps/frontend
    - pnpm run api:generate
  cache:
    - key:
        files:
          - pnpm-lock.yaml
      paths:
        - .pnpm-store/
      policy: pull-push
  variables:
    PNPM_STORE_DIR: "$CI_PROJECT_DIR/.pnpm-store"
  rules:
    - if: $CI_MERGE_REQUEST_IID
      changes:
        - apps/frontend/**/*
        - package.json
        - pnpm-lock.yaml
        - tsconfig.base.json
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps/frontend/**/*
        - package.json
        - pnpm-lock.yaml
        - tsconfig.base.json

lint:frontend:
  extends: .frontend_base
  stage: verify
  script:
    - cd apps/frontend
    - pnpm lint

build:frontend:
  extends: .frontend_base
  stage: verify
  script:
    - cd apps/frontend
    - pnpm build
